<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Flappy Bird</title>
  <link rel="stylesheet" href="style.css">
  <link rel="icon" href="images/favicon.png" type="image/png">
</head>

<body>
  <div class="background"></div>
  <img src="images/Bird.png" alt="bird" class="bird" id="bird-1">

  <div class="message messageStyle">
    Press <b>Enter</b> to start<br>
    <p><span style="color:red;">â†‘</span> ArrowUp to control</p>
  </div>

  <div class="score">
    <span class="score_title"></span>
    <span class="score_val"></span>
  </div>

  <script>
    let move_speed = 3, gravity = 0.5;
    let bird = document.querySelector('.bird');
    let img = document.getElementById('bird-1');
    let sound_point = new Audio('soundeffect/point.mp3');
    let sound_die = new Audio('soundeffect/die.mp3');

    let bird_props;
    let background = document.querySelector('.background').getBoundingClientRect();

    let score_val = document.querySelector('.score_val');
    let message = document.querySelector('.message');
    let score_title = document.querySelector('.score_title');

    let game_state = 'Start';
    img.style.display = 'none';
    message.classList.add('messageStyle');

    document.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        if (game_state !== 'Play') {
          startGame(); // Restart game without refreshing
        }
      }
    });

    function startGame() {
      // Reset everything
      document.querySelectorAll('.pipe_sprite').forEach((e) => e.remove());
      img.style.display = 'block';
      bird.style.top = '40vh';
      bird.style.left = '30vw';
      bird_props = bird.getBoundingClientRect();
      game_state = 'Play';
      message.innerHTML = '';
      score_title.innerHTML = 'Score: ';
      score_val.innerHTML = '0';
      message.classList.remove('messageStyle');

      // Start game loops
      play();
    }

    function play() {
      let bird_dy = 0;
      let pipe_gap = 35;
      let pipe_separation = 0;
      let score = 0;

      function move() {
        if (game_state !== 'Play') return;

        let pipe_sprite = document.querySelectorAll('.pipe_sprite');
        pipe_sprite.forEach((element) => {
          let pipe_sprite_props = element.getBoundingClientRect();
          bird_props = bird.getBoundingClientRect();

          if (pipe_sprite_props.right <= 0) {
            element.remove();
          } else {
            // Collision Detection
            if (
              bird_props.left < pipe_sprite_props.left + pipe_sprite_props.width &&
              bird_props.left + bird_props.width > pipe_sprite_props.left &&
              bird_props.top < pipe_sprite_props.top + pipe_sprite_props.height &&
              bird_props.top + bird_props.height > pipe_sprite_props.top
            ) {
              endGame();
              return;
            } else {
              // Scoring
              if (
                pipe_sprite_props.right < bird_props.left &&
                element.increase_score === '1'
              ) {
                score++;
                score_val.innerHTML = score;
                sound_point.play();
                element.increase_score = '0';
              }
              element.style.left = pipe_sprite_props.left - move_speed + 'px';
            }
          }
        });

        requestAnimationFrame(move);
      }

      function apply_gravity() {
        if (game_state !== 'Play') return;
        bird_dy += gravity;

        document.onkeydown = (e) => {
          if (e.key === 'ArrowUp') {
            bird_dy = -7.6;
          }
        };

        if (bird_props.top <= 0 || bird_props.bottom >= background.bottom) {
          endGame();
          return;
        }

        bird.style.top = bird_props.top + bird_dy + 'px';
        bird_props = bird.getBoundingClientRect();
        requestAnimationFrame(apply_gravity);
      }

      function create_pipe() {
        if (game_state !== 'Play') return;

        if (pipe_separation > 115) {
          pipe_separation = 0;
          let pipe_posi = Math.floor(Math.random() * 43) + 8;

          let pipe_sprite_inv = document.createElement('div');
          pipe_sprite_inv.className = 'pipe_sprite';
          pipe_sprite_inv.style.top = pipe_posi - 70 + 'vh';
          pipe_sprite_inv.style.left = '100vw';
          document.body.appendChild(pipe_sprite_inv);

          let pipe_sprite = document.createElement('div');
          pipe_sprite.className = 'pipe_sprite';
          pipe_sprite.style.top = pipe_posi + pipe_gap + 'vh';
          pipe_sprite.style.left = '100vw';
          pipe_sprite.increase_score = '1';
          document.body.appendChild(pipe_sprite);
        }
        pipe_separation++;
        requestAnimationFrame(create_pipe);
      }

      function endGame() {
        game_state = 'End';
        message.innerHTML = 'Game Over'.fontcolor('red') + '<br>Press Enter to Restart';
        message.classList.add('messageStyle');
        img.style.display = 'none';
        sound_die.play();
      }

      requestAnimationFrame(move);
      requestAnimationFrame(apply_gravity);
      requestAnimationFrame(create_pipe);
    }
  </script>
</body>
</html>
